<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot QR</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>WhatsApp Bot QR</h1>
        <div id="qrcode"></div>
        <div id="status" class="status loading">Esperando conexión...</div>
        <button id="controlButton" class="control-button">Activar Bot</button>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script>
        const statusDiv = document.getElementById('status');
        const qrcodeDiv = document.getElementById('qrcode');
        const controlButton = document.getElementById('controlButton');
        let isBotActive = false;
        let ws = null;

        function connectWebSocket() {
            // Obtener la URL base del servidor
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket conectado');
                updateStatus('loading', 'Conectado al servidor');
            };

            ws.onclose = () => {
                console.log('WebSocket desconectado');
                updateStatus('disconnected', 'Conexión perdida');
                // Intentar reconectar después de 5 segundos
                setTimeout(connectWebSocket, 5000);
            };

            ws.onerror = (error) => {
                console.error('Error en WebSocket:', error);
                updateStatus('disconnected', 'Error de conexión');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Mensaje recibido:', data);
                    
                    switch(data.type) {
                        case 'qr':
                            showQR(data.qr);
                            updateStatus('loading', 'Escanea el código QR con WhatsApp');
                            break;
                        case 'connected':
                            qrcodeDiv.innerHTML = '<p style="color: #00f2ff;">✅ Conectado</p>';
                            updateStatus('connected', 'Bot conectado y funcionando');
                            break;
                        case 'disconnected':
                            updateStatus('disconnected', 'Bot desconectado');
                            break;
                        case 'botStatus':
                            isBotActive = data.active;
                            controlButton.textContent = isBotActive ? 'Desactivar Bot' : 'Activar Bot';
                            controlButton.classList.toggle('active', isBotActive);
                            break;
                    }
                } catch (error) {
                    console.error('Error al procesar mensaje:', error);
                }
            };
        }

        function updateStatus(status, message) {
            statusDiv.className = 'status ' + status;
            statusDiv.textContent = message;
        }

        function showQR(qr) {
            console.log('Intentando mostrar QR...');
            qrcodeDiv.innerHTML = '';
            try {
                QRCode.toCanvas(qrcodeDiv, qr, {
                    width: 300,
                    margin: 1,
                    color: {
                        dark: '#00f2ff',
                        light: '#ffffff'
                    }
                }, function (error) {
                    if (error) {
                        console.error('Error al generar QR:', error);
                        qrcodeDiv.innerHTML = '<p style="color: #ff3e3e;">Error al generar el código QR</p>';
                    } else {
                        console.log('QR generado exitosamente');
                    }
                });
            } catch (error) {
                console.error('Error al mostrar QR:', error);
                qrcodeDiv.innerHTML = '<p style="color: #ff3e3e;">Error al mostrar el código QR</p>';
            }
        }

        function toggleBot() {
            isBotActive = !isBotActive;
            controlButton.textContent = isBotActive ? 'Desactivar Bot' : 'Activar Bot';
            controlButton.classList.toggle('active', isBotActive);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'toggle',
                    active: isBotActive
                }));
            }
        }

        // Iniciar conexión WebSocket
        connectWebSocket();

        // Agregar evento al botón
        controlButton.addEventListener('click', toggleBot);
    </script>
</body>
</html> 